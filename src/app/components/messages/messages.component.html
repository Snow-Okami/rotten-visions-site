<div class="content-wrapper">
  <div [ngClass]="{'body': true, 'mobile': mobileQuery.matches}">

    <!-- Messages Card For Desktop Starts Here -->
    <mat-card *ngIf="!mobileQuery.matches">

      <!-- Messages Title Bar Starts Here -->
      <div class="row">

        <!-- Back Button Appears Here -->
        <div class="col w20"></div> <div class="col w2"> </div> <div class="col w2"></div>

        <!-- Message Title Will Appear Here -->
        <div class="col w70 t-al-center card-title" style="max-width: 750px;">
          <button mat-icon-button matTooltip="Back" [matTooltipPosition]="'above'" class="back" [ngClass]="{ 'hidden': !chatView }" (click)="hideMessages()">
            <mat-icon aria-label="icon-button">arrow_back</mat-icon>
          </button>

          <button mat-icon-button matTooltip="Back" [matTooltipPosition]="'above'" class="back" [ngClass]="{ 'hidden': !createView }" (click)="hideMessages()">
            <mat-icon aria-label="icon-button">arrow_back</mat-icon>
          </button>

          <mat-icon matPrefix class="title-item"> chat </mat-icon>
          <h4 class="title-item m-l-5" [ngClass]="{ 'hidden': !chatView }"> Messages - {{ chat.type ? chat.fullName : chat.users | nameonly: user }} </h4>

          <!-- User's own name appears when no chat selected. -->
          <h4 class="title-item m-l-5" [ngClass]="{ 'hidden': chatView }"> Welcome {{ user.firstName }}! </h4>

          <button mat-icon-button matTooltip="Show/Hide your text before send" [matTooltipPosition]="'above'" class="visibility" [ngClass]="{ 'hidden': !chatView }" (click)="alterQuickText()">
            <mat-icon aria-label="icon-button" [ngClass]="{ 'hidden': quickText }">visibility_off</mat-icon>
            <mat-icon aria-label="icon-button" [ngClass]="{ 'hidden': !quickText }">visibility</mat-icon>
          </button>
        </div>

      </div>

      <!-- Chat List Wrapper Starts Here -->
      <div class="row">
        <div class="col w20" style="position: relative;">

          <!-- Chat list wrapper -->
          <div [ngClass]="{ 'hidden': !chatLoader && chats.length === 0 }">
            <perfect-scrollbar #chatList style="position: relative; max-width: 230px; max-height: 414px; min-height: 414px;" [config]="config" (psYReachEnd)="loadChats($event)">
              <mat-list>
  
                <!-- Message loader will be shown here -->
                <ul *ngIf="chatLoader">
                  <li class="row chat-row-wrapper t-al-center">
                    <div class="col">
                      <mat-progress-spinner class="chat-loader" [color]="'primary'" [mode]="'indeterminate'" [diameter]="30" [strokeWidth]="4"></mat-progress-spinner>
                    </div>
                  </li>
                </ul>
  
                <!-- Messages will be loaded here -->
                <mat-list-item *ngFor="let c of chats">
                  <mat-icon mat-list-icon class="chat-image"> person </mat-icon>
                  <h4 mat-line class="chat-name" (click)="showItsMessages(c)"> {{ c.type ? c.fullName : c.users | nameonly: user }} </h4>
                  <span [innerHTML]="sanitizer.bypassSecurityTrustHtml(c.lastMessage.text)" class="writable" mat-line></span>
                  <mat-divider></mat-divider>
                </mat-list-item>
  
              </mat-list>
            </perfect-scrollbar>
          </div>

          <div [ngClass]="{ 'hidden': !chatLoader && chats.length > 0 }">
            <div style="height: 414px; position: relative; max-width: 230px;">
              <h4 class="init-text t-al-center"> SORRY! no chat found! </h4>
            </div>
          </div>


          <!-- Create Chat Button -->
          <button (click)="visitCreate()" mat-fab class="new-message" matTooltip="New Message" matTooltipPosition="before" [ngClass]="{ 'hidden': createView }">
            <mat-icon aria-label="Create new message icon">add</mat-icon>
          </button>

        </div>

        <div class="col w2"> <mat-divider style="max-height: 414px; min-height: 414px;" [vertical]="true"></mat-divider> </div>

        <div class="col w2"> </div>

        <!-- SHOW for the messages -->
        <div class="col w70" [ngClass]="{ 'hidden': !chatView || createView }">

          <perfect-scrollbar #messageList style="position: relative; max-width: 750px; max-height: 336px; min-height: 336px;" [config]="config" (psYReachStart)="loadMessages($event)">
            <mat-list>

              <ul>

                <!-- Message loader will be shown here -->
                <li class="row chat-row-wrapper t-al-center" *ngIf="messageLoader">
                  <div class="col">
                    <mat-progress-spinner class="message-loader" [color]="'primary'" [mode]="'indeterminate'" [diameter]="30" [strokeWidth]="4"></mat-progress-spinner>
                  </div>
                </li>

                <!-- Messages will repeat here -->
                <li *ngFor="let m of chat.messages" class="row chat-row-wrapper">
                  <div class="chat-wrapper" [ngClass]="{ 'right': m.createdBy.email === user.email, 'm-r-30': m.createdBy.email !== user.email, 'm-l-30': m.createdBy.email === user.email }">
                    <div class="t-al-center chat-image"><mat-icon mat-list-icon> person </mat-icon></div>

                    <div class="col wauto">
                      <span [innerHTML]="sanitizer.bypassSecurityTrustHtml(m.text)" class="writable"></span>
                      <h4 class="mat-line"> {{ m.createdBy.fullName }} </h4>
                    </div>
                  </div>
                </li>

                <li *ngIf="chat.isTyping.show" class="row chat-row-wrapper opacity-q4">
                  <div class="chat-wrapper m-r-30">
                    <div class="t-al-center chat-image"><mat-icon mat-list-icon> person </mat-icon></div>

                    <div class="col wauto">
                      <span [ngClass]="{ 'hidden': !chat.isTyping.lastMessage.text.length }" [innerHTML]="sanitizer.bypassSecurityTrustHtml(chat.isTyping.lastMessage.text)" class="writable"></span>
                      <h6 class="mat-line"> {{ chat.isTyping.lastMessage.createdBy.fullName }} is typing... </h6>
                    </div>
                  </div>
                </li>

              </ul>

            </mat-list>
          </perfect-scrollbar>

          <!-- Input Section Will Be Used For Message -->
          <div class="row" style="max-width: 750px;">
            <mat-card class="chat-input-wrapper">
              <mat-card-content>

                <div class="col w90">
                  <mat-form-field>
                    <textarea matInput #message matTextareaAutosize placeholder="Say something..." [formControl]="text" (keydown)="keyDown($event)" (keyup)="keyUp($event)" (blur)="blur($event)"></textarea>
                  </mat-form-field>
                </div>

                <div class="col w10 t-al-center v-al-b send-btn">
                  <button mat-icon-button matTooltip="Send" [matTooltipPosition]="'above'" (click)="sendThis()">
                    <mat-icon aria-label="send-button"> send </mat-icon>
                  </button>
                </div>
              </mat-card-content>
            </mat-card>

          </div>

        </div>

        <!-- SHOW when no chat is selected -->
        <div class="col w70" [ngClass]="{ 'hidden': chatView || createView }">
          <div style="height: 414px; position: relative; max-width: 750px;">
            <h4 class="init-text t-al-center"> SORRY! no chat selected! </h4>
          </div>
        </div>

        <!-- SHOW for the messages -->
        <div class="col w70" [ngClass]="{ 'hidden': !createView }">

          <div class="row" style="max-width: 750px; position: relative;">
            
            <!-- Create chat form -->
            <form #createChatForm (ngSubmit)="createChat($event);">
              <ul class="message-list-wrapper">

                <!-- Group name field when exists. -->
                <li class="row" *ngIf="selectedUsers.length > 1">
                  <mat-form-field>
                    <input matInput placeholder="Group name" autocomplete="off" [formControl]="groupFullName" required>
                    <mat-error *ngIf="groupFullName.hasError('invalid_characters')">
                      Only space is not allowed.
                    </mat-error>
                    <mat-error *ngIf="groupFullName.hasError('required')">
                      Group name is required
                    </mat-error>
                  </mat-form-field>
                </li>

                <!-- Input list for user search. -->
                <li class="row">
                  <mat-form-field>
                    <mat-chip-list #chipList>
                      <mat-chip *ngFor="let u of selectedUsers" [selectable]="true"
                              [removable]="true" (removed)="remove(u)">
                        {{ u.fullName }}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                      <input placeholder="Selected user..."
                            autocomplete="off"
                            (keyup)="searchUsers($event)"
                            [matChipInputFor]="chipList"
                            [matChipInputAddOnBlur]="true"
                            [formControl]="searchInput">
                    </mat-chip-list>
                  </mat-form-field>
                </li>

              </ul>

              <!-- Create Chat Button -->
              <button type="submit" mat-fab class="start-chat" matTooltip="Start Chat" matTooltipPosition="before">
                <mat-icon aria-label="Start chat icon">add</mat-icon>
              </button>
            </form>

          </div>

          <perfect-scrollbar #messageList style="position: relative; max-width: 750px; max-height: 314px; min-height: 314px;" [config]="config" (psYReachStart)="loadMessages($event)">
            <mat-list>

              <!-- Messages will be loaded here -->
              <mat-list-item *ngFor="let u of searchedUsers">
                <h4 mat-line class="chat-name"> {{ u.fullName }} </h4>
                <p> {{ u.email}} </p>
                <mat-checkbox class="suser-select-margin" [(ngModel)]="u.selected" (change)="alterSelected(u)"></mat-checkbox>
                <mat-divider></mat-divider>
              </mat-list-item>

            </mat-list>
          </perfect-scrollbar>

        </div>

      </div>

    </mat-card>
    <!-- Messages Card For Desktop Ends Here -->

    <div class="row" *ngIf="mobileQuery.matches">
      <mat-toolbar color="primary" class="psynapsus-toolbar" [ngClass]="{ 'hidden': !chatView }">

        <mat-toolbar-row>
          <!-- Help to improve the performance. -->
          <button aria-label="navigate-back" mat-icon-button [ngClass]="{ 'hidden': !chatView }" (click)="hideMessages()"><mat-icon aria-label="icon-button">arrow_back</mat-icon></button>
          <h1 class="psynapsus-chat-title"> {{ chat.type ? chat.fullName : chat.users | nameonly: user }} </h1>
          <div class="option-wrapper">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon matSuffix class="material-icons"> more_vert </mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item [ngClass]="{ 'hidden': !chatView }" (click)="alterQuickText()">
                <mat-icon aria-label="icon-button" [ngClass]="{ 'hidden': quickText }">visibility_off</mat-icon>
                <mat-icon aria-label="icon-button" [ngClass]="{ 'hidden': !quickText }">visibility</mat-icon>
                <span>Quick text</span>
              </button>
            </mat-menu>
          </div>
        </mat-toolbar-row>

      </mat-toolbar>

      <!-- <mat-toolbar color="primary" class="psynapsus-toolbar" [ngClass]="{ 'hidden': !chatView }">

        <button mat-icon-button class="back" [ngClass]="{ 'hidden': !chatView }" (click)="hideMessages()">
          <mat-icon aria-label="icon-button">arrow_back</mat-icon>
        </button>
        <h1 class="title-item m-l-5 force" [ngClass]="{ 'hidden': !chatView }"> {{ chat.type ? chat.fullName : chat.users | nameonly: user }} </h1>
        <div class="power-wrapper">
          <mat-icon matSuffix class="material-icons" matTooltip="Logout!" matTooltipPosition="before"> power_settings_new </mat-icon>
        </div>
      </mat-toolbar> -->

      <div class="col w100" [ngClass]="{ 'hidden': createView || chatView }">
          
        <div [ngClass]="{ 'hidden': !chatLoader && chats.length === 0 }">
          <mat-list>
  
            <!-- Message loader will be shown here -->
            <ul *ngIf="chatLoader">
              <li class="row chat-row-wrapper t-al-center">
                <div class="col">
                  <mat-progress-spinner class="chat-loader" [color]="'primary'" [mode]="'indeterminate'" [diameter]="30" [strokeWidth]="4"></mat-progress-spinner>
                </div>
              </li>
            </ul>
    
            <!-- Messages will be loaded here -->
            <mat-list-item *ngFor="let c of chats">
              <mat-icon mat-list-icon class="chat-image"> person </mat-icon>
              <h4 mat-line class="chat-name" (click)="showItsMessages(c)"> {{ c.type ? c.fullName : c.users | nameonly: user }} </h4>
              <span [innerHTML]="sanitizer.bypassSecurityTrustHtml(c.lastMessage.text)" class="writable" mat-line></span>
              <mat-divider></mat-divider>
            </mat-list-item>
    
          </mat-list>
        </div>

        <div [ngClass]="{ 'hidden': !chatLoader && chats.length > 0 }">
          <div style="position: relative;">
            <h4 class="init-text t-al-center"> SORRY! no chat found! </h4>
          </div>
        </div>

        <button (click)="visitCreate()" mat-fab class="new-message" matTooltip="New Message" matTooltipPosition="before">
          <mat-icon aria-label="Create new message icon">add</mat-icon>
        </button>
      </div>

      <div class="col w100" [ngClass]="{ 'hidden': !chatView }">

        <div class="message-wrapper">
          <ul>

            <!-- Message loader will be shown here -->
            <li class="row chat-row-wrapper t-al-center" *ngIf="messageLoader">
              <div class="col">
                <mat-progress-spinner class="message-loader" [color]="'primary'" [mode]="'indeterminate'" [diameter]="30" [strokeWidth]="4"></mat-progress-spinner>
              </div>
            </li>
  
            <!-- Messages will repeat here -->
            <li *ngFor="let m of chat.messages" class="row chat-row-wrapper">
              <div class="chat-wrapper" [ngClass]="{ 'right': m.createdBy.email === user.email, 'm-r-30': m.createdBy.email !== user.email, 'm-l-30': m.createdBy.email === user.email, 'force': mobileQuery.matches }">
                <div class="t-al-center chat-image"><mat-icon mat-list-icon> person </mat-icon></div>
  
                <div class="col wauto">
                  <span [innerHTML]="sanitizer.bypassSecurityTrustHtml(m.text)" class="writable"></span>
                  <h4 class="mat-line"> {{ m.createdBy.fullName }} </h4>
                </div>
              </div>
            </li>
  
            <li *ngIf="chat.isTyping.show" class="row chat-row-wrapper opacity-q4">
              <div class="chat-wrapper m-r-30" [ngClass]="{ 'force': mobileQuery.matches }">
                <div class="t-al-center chat-image"><mat-icon mat-list-icon> person </mat-icon></div>
  
                <div class="col wauto">
                  <span [ngClass]="{ 'hidden': !chat.isTyping.lastMessage.text.length }" [innerHTML]="sanitizer.bypassSecurityTrustHtml(chat.isTyping.lastMessage.text)" class="writable"></span>
                  <h6 class="mat-line"> {{ chat.isTyping.lastMessage.createdBy.fullName }} is typing... </h6>
                </div>
              </div>
            </li>
  
          </ul>
        </div>

        <div class="input-box-wrapper">
          <!-- Input Section Will Be Used For Message -->
          <div class="row">
            <mat-card class="chat-input-wrapper">
              <mat-card-content>
  
                <div class="col w90 inline">
                  <mat-form-field>
                    <textarea matInput #message matTextareaAutosize placeholder="Say something..." [formControl]="text" (keydown)="keyDown($event)" (keyup)="keyUp($event)" (blur)="blur($event)"></textarea>
                  </mat-form-field>
                </div>
  
                <div class="col w10 inline t-al-center v-al-b send-btn">
                  <button mat-icon-button matTooltip="Send" [matTooltipPosition]="'above'" (click)="sendThis()">
                    <mat-icon aria-label="send-button"> send </mat-icon>
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
  
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
